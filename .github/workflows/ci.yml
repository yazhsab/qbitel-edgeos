name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable
        with:
          components: clippy, rustfmt

      - name: Install embedded targets
        run: |
          rustup target add thumbv7em-none-eabihf
          rustup target add thumbv8m.main-none-eabihf
          rustup target add riscv32imac-unknown-none-elf

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --workspace --all-features -- -D warnings

      - name: Check (native)
        run: cargo check --workspace --all-features

      - name: Check (STM32H7)
        run: cargo check --workspace --target thumbv7em-none-eabihf --features stm32h7

      - name: Check (STM32U5)
        run: cargo check --workspace --target thumbv8m.main-none-eabihf --features stm32u5

      - name: Check (RISC-V)
        run: cargo check --workspace --target riscv32imac-unknown-none-elf --features riscv

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-test-

      - name: Run tests
        run: cargo test --workspace --all-features

      - name: Run doc tests
        run: cargo test --workspace --doc

  # Code coverage using cargo-tarpaulin
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-coverage-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-coverage-

      - name: Run coverage
        run: |
          cargo tarpaulin --workspace \
            --all-features \
            --out xml \
            --out html \
            --exclude-files "*/tests/*" \
            --exclude-files "*/benches/*" \
            --timeout 300 \
            --ignore-panics

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./cobertura.xml
          fail_ci_if_error: false
          verbose: true

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            cobertura.xml
            tarpaulin-report.html

  # Cryptographic fuzzing using cargo-fuzz
  fuzz-crypto:
    name: Fuzz Crypto
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-action@nightly

      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-fuzz-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-fuzz-

      - name: Create fuzz targets directory
        run: mkdir -p crates/q-crypto/fuzz/fuzz_targets

      - name: Create SHA3 fuzz target
        run: |
          cat > crates/q-crypto/fuzz/fuzz_targets/fuzz_sha3.rs << 'EOF'
          #![no_main]
          use libfuzzer_sys::fuzz_target;

          fuzz_target!(|data: &[u8]| {
              // Fuzz SHA3-256
              if let Ok(_) = std::panic::catch_unwind(|| {
                  // This is a placeholder - actual implementation would use q-crypto
                  let _ = data.len();
              }) {}
          });
          EOF

      - name: Create Cargo.toml for fuzz
        run: |
          cat > crates/q-crypto/fuzz/Cargo.toml << 'EOF'
          [package]
          name = "q-crypto-fuzz"
          version = "0.0.0"
          publish = false
          edition = "2021"

          [package.metadata]
          cargo-fuzz = true

          [dependencies]
          libfuzzer-sys = "0.4"

          [[bin]]
          name = "fuzz_sha3"
          path = "fuzz_targets/fuzz_sha3.rs"
          test = false
          doc = false
          bench = false
          EOF

      - name: Run fuzz tests (time-limited)
        run: |
          cd crates/q-crypto
          timeout 300 cargo +nightly fuzz run fuzz_sha3 -- -max_total_time=300 || true
        continue-on-error: true

  # Property-based testing with proptest
  property-tests:
    name: Property Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-proptest-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-proptest-

      - name: Run property tests
        run: |
          # Run tests with increased iterations for property-based tests
          PROPTEST_CASES=1000 cargo test --workspace --all-features -- --nocapture proptest
        continue-on-error: true

  # Miri for undefined behavior detection
  miri:
    name: Miri
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust nightly with miri
        uses: dtolnay/rust-action@nightly
        with:
          components: miri

      - name: Setup Miri
        run: cargo miri setup

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-miri-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-miri-

      - name: Run Miri on q-crypto
        run: |
          cargo miri test -p q-crypto --lib -- --nocapture 2>&1 | head -500
        env:
          MIRIFLAGS: -Zmiri-disable-isolation -Zmiri-ignore-leaks

  build:
    name: Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - thumbv7em-none-eabihf
          - thumbv8m.main-none-eabihf
          - riscv32imac-unknown-none-elf
        include:
          - target: thumbv7em-none-eabihf
            features: stm32h7
          - target: thumbv8m.main-none-eabihf
            features: stm32u5
          - target: riscv32imac-unknown-none-elf
            features: riscv

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Install target
        run: rustup target add ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.target }}-

      - name: Build bootloader
        run: |
          cargo build --package q-boot \
            --target ${{ matrix.target }} \
            --features ${{ matrix.features }} \
            --release

      - name: Build kernel
        run: |
          cargo build --package q-kernel \
            --target ${{ matrix.target }} \
            --features ${{ matrix.features }} \
            --release

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.target }}
          path: |
            target/${{ matrix.target }}/release/q-boot
            target/${{ matrix.target }}/release/q-kernel

  python-tools:
    name: Python Tools
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy pytest pytest-cov

      - name: Install liboqs (for real PQC)
        run: |
          pip install liboqs-python || echo "liboqs not available, using fallback"

      - name: Install q-provision
        run: pip install -e tools/q-provision[dev]

      - name: Install q-sign
        run: pip install -e tools/q-sign[dev]

      - name: Lint with ruff
        run: |
          ruff check tools/q-provision/src
          ruff check tools/q-sign/src

      - name: Type check with mypy
        run: |
          mypy tools/q-provision/src
          mypy tools/q-sign/src

      - name: Run tests with coverage
        run: |
          pytest tools/q-provision/tests -v --cov=q_provision --cov-report=xml || true
          pytest tools/q-sign/tests -v --cov=q_sign --cov-report=xml || true

      - name: Check PQC availability
        run: |
          python -c "from q_provision.keygen import check_pqc_availability; print(check_pqc_availability())"
          python -c "from q_sign.signer import check_pqc_availability; print(check_pqc_availability())"

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Install cargo-deny
        run: cargo install cargo-deny

      - name: Run security audit
        run: cargo audit

      - name: Check licenses and security advisories
        run: cargo deny check || true

      - name: Check for unsafe code
        run: |
          echo "=== Unsafe code usage ==="
          echo "Total unsafe blocks:"
          grep -r "unsafe" crates/ --include="*.rs" | wc -l || true
          echo ""
          echo "Unsafe by crate:"
          for crate in crates/*/; do
            count=$(grep -r "unsafe" "$crate" --include="*.rs" 2>/dev/null | wc -l || echo "0")
            echo "  $(basename $crate): $count"
          done

      - name: SAST with cargo-geiger
        run: |
          cargo install cargo-geiger || true
          cargo geiger --all-features 2>&1 | head -100 || true
        continue-on-error: true

  # Run cryptographic Known Answer Tests
  crypto-kat:
    name: Crypto KAT
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-kat-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-kat-

      - name: Run KAT tests
        run: |
          cargo test -p q-crypto --all-features -- kat --nocapture

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Build documentation
        run: cargo doc --workspace --no-deps --all-features
        env:
          RUSTDOCFLAGS: -D warnings

      - name: Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: target/doc

  # Size check for embedded builds
  size-check:
    name: Binary Size Check
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: firmware-thumbv7em-none-eabihf
          path: firmware

      - name: Install binutils
        run: sudo apt-get install -y binutils-arm-none-eabi

      - name: Check binary sizes
        run: |
          echo "=== Binary Sizes ==="
          for file in firmware/*; do
            if [ -f "$file" ]; then
              size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")
              echo "$(basename $file): $size bytes"
            fi
          done
          echo ""
          echo "=== Section Sizes ==="
          arm-none-eabi-size firmware/* 2>/dev/null || true
